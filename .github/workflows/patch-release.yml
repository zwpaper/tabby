name: Patch Release

on:
  issue_comment:
    types: [created]

jobs:
  patch-release:
    if: github.event.issue.pull_request && github.event.issue.state == 'closed' && startsWith(github.event.comment.body, '/release ') && (github.event.comment.author_association == 'OWNER' || github.event.comment.author_association == 'MEMBER' || github.event.comment.author_association == 'COLLABORATOR')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Parse Version
        id: parse_version
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"
          # Use regex to parse version and optional pre suffix
          # Matches: /release 0.98, /release v0.98, /release 0.98 pre, /release v0.98 pre
          if [[ "$COMMENT_BODY" =~ ^/release[[:space:]]+v?([0-9]+\.[0-9]+)([[:space:]]+pre)?$ ]]; then
            VERSION_NUMBER="${BASH_REMATCH[1]}"
            PRE_SUFFIX="${BASH_REMATCH[2]}"

            MAJOR=$(echo "$VERSION_NUMBER" | cut -d. -f1)
            MINOR=$(echo "$VERSION_NUMBER" | cut -d. -f2)

            # Main branch is always release-vscode-MAJOR-MINOR
            MAIN_BRANCH="release-vscode-$MAJOR-$(printf "%02d" $((10#$MINOR)))"

            if [[ -n "$PRE_SUFFIX" ]]; then
              # If pre is present, we first target minor - 1
              PRE_BRANCH="release-vscode-$MAJOR-$(printf "%02d" $((10#$MINOR - 1)))"
              echo "is_pre=true" >> $GITHUB_OUTPUT
              echo "pre_branch=$PRE_BRANCH" >> $GITHUB_OUTPUT
            else
              echo "is_pre=false" >> $GITHUB_OUTPUT
            fi

            echo "version=v$VERSION_NUMBER" >> $GITHUB_OUTPUT
            echo "main_branch=$MAIN_BRANCH" >> $GITHUB_OUTPUT
            echo "parse_failed=false" >> $GITHUB_OUTPUT
          else
            echo "parse_failed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Explain Usage
        if: steps.parse_version.outputs.parse_failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "⚠️ **Invalid release command format**\n\nUsage:\n- `/release 0.98` : Cherry-pick to `release-vscode-0-98` and release.\n- `/release 0.98 pre` : Cherry-pick to `release-vscode-0-97` and release, then wait for approval before releasing to `release-vscode-0-98`.\n\nNote: The `v` prefix is optional (e.g., `/release v0.98`)."
            });
            core.setFailed('Invalid release command format.');

      - name: Add Labels to PR
        if: steps.parse_version.outputs.parse_failed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const labels = ['cherry-pick', '${{ steps.parse_version.outputs.version }}'];
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: labels
            });

      - name: Checkout
        if: steps.parse_version.outputs.parse_failed == 'false'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.POCHI_HOMEBREW_GITHUB_TOKEN }}

      - name: Get PR Merged Commit
        if: steps.parse_version.outputs.parse_failed == 'false'
        id: get_commit
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            if (!pr.data.merged) {
              core.setFailed('PR is not merged. Cannot cherry-pick.');
              return;
            }
            core.setOutput('merge_commit_sha', pr.data.merge_commit_sha);

      - name: Setup Bun
        if: steps.parse_version.outputs.parse_failed == 'false'
        uses: oven-sh/setup-bun@v2

      - name: Cherry-pick and Push (Pre Branch)
        if: steps.parse_version.outputs.parse_failed == 'false' && steps.parse_version.outputs.is_pre == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Checkout pre-branch
          git checkout ${{ steps.parse_version.outputs.pre_branch }}

          # Fetch the commit to ensure it exists locally
          git fetch origin ${{ steps.get_commit.outputs.merge_commit_sha }}

          # Cherry-pick the merged commit
          git cherry-pick ${{ steps.get_commit.outputs.merge_commit_sha }}

          bun install --frozen-lockfile

          git push origin ${{ steps.parse_version.outputs.pre_branch }}

      - name: Wait for Workflows (Pre Branch)
        if: steps.parse_version.outputs.parse_failed == 'false' && steps.parse_version.outputs.is_pre == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ steps.parse_version.outputs.pre_branch }}"
          SHA=$(git rev-parse HEAD)
          echo "Waiting for workflows on $BRANCH ($SHA) to complete..."

          # Give GitHub a moment to trigger workflows
          sleep 10

          while true; do
            OUTPUT=$(gh run list --branch "$BRANCH" --commit "$SHA" --json status,conclusion,name)

            COUNT=$(echo "$OUTPUT" | jq 'length')
            if [[ "$COUNT" -eq 0 ]]; then
               echo "No workflows found yet. Waiting..."
               sleep 10
               continue
            fi

            FAILED_COUNT=$(echo "$OUTPUT" | jq '[.[] | select(.conclusion == "failure" or .conclusion == "timed_out")] | length')
            if [[ "$FAILED_COUNT" -gt 0 ]]; then
              echo "❌ Some workflows failed:"
              echo "$OUTPUT" | jq '.[] | select(.conclusion == "failure" or .conclusion == "timed_out") | .name + ": " + .conclusion'
              exit 1
            fi

            PENDING_COUNT=$(echo "$OUTPUT" | jq '[.[] | select(.status != "completed")] | length')

            if [[ "$PENDING_COUNT" -eq 0 ]]; then
              echo "✅ All workflows passed."
              break
            fi

            echo "⏳ $PENDING_COUNT workflows still running..."
            sleep 30
          done

      - name: Release (Pre Branch)
        if: steps.parse_version.outputs.parse_failed == 'false' && steps.parse_version.outputs.is_pre == 'true'
        run: |
          git checkout ${{ steps.parse_version.outputs.pre_branch }}
          cd packages/vscode
          bun run release --release patch --quiet --yes

      - name: Manual Approval
        if: steps.parse_version.outputs.parse_failed == 'false' && steps.parse_version.outputs.is_pre == 'true'
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: wsxiaoys,zwpaper
          minimum-approvals: 1
          issue-title: "Release patch release for ${{ steps.parse_version.outputs.version }} to ${{ steps.parse_version.outputs.main_branch }}"
          issue-body: |
            Please approve or deny the release of ${{ steps.parse_version.outputs.version }} to ${{ steps.parse_version.outputs.main_branch }}.
            Pull Request: ${{ github.event.issue.html_url }}

            Tips:
            - Approval keywords: approve, approved, lgtm, yes
            - Denied keywords: deny, denied, no
          exclude-workflow-initiator-as-approver: false
          fail-on-denial: true

      - name: Cherry-pick and Push (Main Branch)
        if: steps.parse_version.outputs.parse_failed == 'false'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Checkout main-branch
          git checkout ${{ steps.parse_version.outputs.main_branch }}

          # Fetch the commit to ensure it exists locally
          git fetch origin ${{ steps.get_commit.outputs.merge_commit_sha }}

          # Cherry-pick the merged commit
          git cherry-pick ${{ steps.get_commit.outputs.merge_commit_sha }}

          bun install --frozen-lockfile

          git push origin ${{ steps.parse_version.outputs.main_branch }}

      - name: Wait for Workflows (Main Branch)
        if: steps.parse_version.outputs.parse_failed == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ steps.parse_version.outputs.main_branch }}"
          SHA=$(git rev-parse HEAD)
          echo "Waiting for workflows on $BRANCH ($SHA) to complete..."

          # Give GitHub a moment to trigger workflows
          sleep 10

          while true; do
            OUTPUT=$(gh run list --branch "$BRANCH" --commit "$SHA" --json status,conclusion,name)

            COUNT=$(echo "$OUTPUT" | jq 'length')
            if [[ "$COUNT" -eq 0 ]]; then
               echo "No workflows found yet. Waiting..."
               sleep 10
               continue
            fi

            FAILED_COUNT=$(echo "$OUTPUT" | jq '[.[] | select(.conclusion == "failure" or .conclusion == "timed_out")] | length')
            if [[ "$FAILED_COUNT" -gt 0 ]]; then
              echo "❌ Some workflows failed:"
              echo "$OUTPUT" | jq '.[] | select(.conclusion == "failure" or .conclusion == "timed_out") | .name + ": " + .conclusion'
              exit 1
            fi

            PENDING_COUNT=$(echo "$OUTPUT" | jq '[.[] | select(.status != "completed")] | length')

            if [[ "$PENDING_COUNT" -eq 0 ]]; then
              echo "✅ All workflows passed."
              break
            fi

            echo "⏳ $PENDING_COUNT workflows still running..."
            sleep 30
          done

      - name: Release (Main Branch)
        if: steps.parse_version.outputs.parse_failed == 'false'
        run: |
          git checkout ${{ steps.parse_version.outputs.main_branch }}
          cd packages/vscode
          bun run release --release patch --quiet --yes

      - name: Report Failure
        if: failure() && steps.parse_version.outputs.parse_failed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `❌ **Patch Release Workflow Failed**\n\nThe workflow execution encountered an error. Please check the logs for more details:\n${runUrl}`
            });